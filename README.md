<!-- omit in toc -->
Alternative Source Generator for Unity
======================================

Alternative Source Generator is built on the Unity native functions.

- âœ… Unity Package Manager Support
- âœ… No Complicated IDE Environment Setup
- âœ… No Additional Package Installation


As you already know, Roslyn's source generator is too sophisticated. This framework provides more simple, ease of use and good enough functions for source code generation.


<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

è¶…ç°¡å˜ã«ä½¿ãˆã‚‹ Unity å‘ã‘ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚

<!------- End of Details JA Tag -------></details></p>


![](https://dl.dropbox.com/scl/fi/jijclnarrruxdt590vss1/USG_Panel.png?rlkey=k44lc9swk0mmui849ck7tappk&dl=0)


- [USG Control Centre <sup><sup><sub>*New*</sub></sup></sup>](#usg-control-panel--window)
- [Breaking Changes in v2.0](CHANGELOG.md)
- [TODO](#todo)


<p><details lang="en" open><summary>Table of Contents</summary>

- [Sample Code](#sample-code)
    - [Method Generator](#method-generator)
        - [How to Use](#how-to-use)
        - [Result](#result)
    - [Self-Emit Generator](#self-emit-generator)
        - [Result](#result-1)
- [Output Directory and File Name](#output-directory-and-file-name)
- [Coding Goodies](#coding-goodies)
- [Utility Functions for Build Event](#utility-functions-for-build-event)
- [Technical Notes](#technical-notes)
    - [Naming Convention](#naming-convention)
    - [`<auto-generated/>` Tag](#auto-generated-tag)
- [Unity Editor Integration](#unity-editor-integration)
    - [Installation](#installation)
    - [USG Control Panel \& Window](#usg-control-panel--window)
    - [Context Menu](#context-menu)
- [Troubleshooting](#troubleshooting)
- [Copyright](#copyright)
- [License](#license)
- [Devnote](#devnote)
    - [TODO](#todo)

<!------- End of Details EN Tag -------></details></p>





Sample Code
===========

Here is minimal implementation of source generator.

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

æœ€å°é™ã®ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®æ§‹æˆã¯ã“ã¡ã‚‰ã€‚`StringBuilder` ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§æ›¸ãè¾¼ã‚“ã§ `true` ã‚’è¿”ã›ã° `context.OutputPath` ã«å†…å®¹ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚`false` ã‚’è¿”ã›ã°æ›¸ãè¾¼ã¿ã‚’ä¸­æ­¢ã§ãã¾ã™ã€‚

<!------- End of Details JA Tag -------></details></p>


## Method Generator

This example will add `Panic()` method to target class.

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¯ãƒ©ã‚¹ã« `Panic()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã€‚

<!------- End of Details JA Tag -------></details></p>


```csharp
public class PanicMethodGenerator
{
    static string OutputFileName() => "PanicMethod.cs";  // -> PanicMethod.<TargetClass>.<GeneratorClass>.g.cs

    static bool Emit(USGContext context, StringBuilder sb)
    {
        if (!context.TargetClass.IsClass || context.TargetClass.IsAbstract)
            return false;  // return false to tell USG doesn't write file.

        // code generation
        sb.Append($@"
namespace {context.TargetClass.Namespace}
{{
    internal partial class {context.TargetClass.Name}
    {{
        public void Panic() => throw new System.Exception();
    }}
}}
");
        return true;
    }
}
```



### How to Use


```csharp
using SatorImaging.UnitySourceGenerator;

namespace Sample
{
    // Add attribute to target class to use method generator.
    // Note that class must be defined as partial class.
    [UnitySourceGenerator(typeof(PanicMethodGenerator), OverwriteIfFileExists = false)]
    internal partial class MethodGeneratorSample
    {
    }

}
```

### Result

Generated code looks like this.

```csharp
// <auto-generated>PanicMethodGenerator</auto-generated>

namespace Sample
{
    internal partial class MethodGeneratorSample
    {
        public void Panic() => throw new System.Exception();
    }
}
```



## Self-Emit Generator

Here is target-less, self-emitting generator example.

It is useful to generate static database that cannot be generated on Unity runtime. For example, build asset GUIDs database using `UnityEditor.AssetDatabase`, resource integrity tables, etc.




```csharp
using System.Text;
using SatorImaging.UnitySourceGenerator;

[UnitySourceGenerator(OverwriteIfFileExists = false)]
class MinimalGenerator
{
    static string OutputFileName() => "Test.cs";  // -> Test.<ClassName>.g.cs

    static bool Emit(USGContext context, StringBuilder sb)
    {
        // write content into passed StringBuilder.
        sb.AppendLine($"Asset Path: {context.AssetPath}");
        sb.AppendLine($"Hello World from {typeof(MinimalGenerator)}");

        // you can modify output path. initial file name is that USG updated.
        // NOTE: USG doesn't care the modified path is valid or not.
        context.OutputPath += "_MyFirstTest.txt";

        // return true to tell USG to write content into OutputPath. false to do nothing.
        return true;
    }
}
```



### Result


```csharp
// <auto-generated>MinimalGenerator</auto-generated>
Asset Path: Assets/Scripts/MinimalGenerator.cs
Hello World from Sample.MinimalGenerator
```


Output Directory and File Name
==============================

Source Generator creates `USG.g` folder next to target script and append class names to file name.

Resulting file path will be:

- Assets/Scripts/<b>USG.g</b>/Test<b>.MinimalGenerator.g</b>.cs
- Assets/Scripts/<b>USG.g</b>/PanicMethod<b>.MethodGeneratorSample.PanicMethodGenerator.g</b>.cs

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

æ›¸ãå‡ºã—å…ˆã¯ä¸Šè¨˜ã®é€šã‚Šã€‚ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ»ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹åãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

<!------- End of Details JA Tag -------></details></p>

> NOTE: In above example, output path is modified so that resulting file name is `Test.MinimalGenerator.g.cs_MyFirstTest.txt`




Coding Goodies
==============

There are utility methods for coding source generator more efficient and readable.

- `StringBuilder` Extentions
    - `IndentLine` / `IndentAppend`
    - `IndentBegin` / `IndentEnd`
    - `IndentLevel` / `IndentChar` / `IndentSize`
- `USGFullNameOf`
    - `usg`
- `USGReflection`
    - `GetAllPublicInstanceFieldAndProperty`
    - `TryGetFieldOrPropertyType`
    - `GetEnumNamesAndValuesAsDictionary`
    - `GetEnumNamesAndValuesAsTuple`

`usg` is a special utility that is designed for refactoring-ready source generator more readable, script template import it as a static library by default.


<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

`System.Reflection` ç³»ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼ã¨ `StringBuilder` ã®æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ç¾¤ã€‚

`usg` ã¯ç‰¹æ®Šã§ã€ã‚¯ãƒ©ã‚¹åã‚„ã‚‰ä½•ã‚„ã‚‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«å¼·ã„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã™ã‚‹ã¨èª­ã¿ã¥ã‚‰ããªã£ã¦ã—ã¾ã†ã®ã‚’ç·©å’Œã™ã‚‹ãŸã‚ã®ãƒ¢ãƒã€‚

`{typeof(MyClass).FullName}.{nameof(MyClass.Property)}` ã©ã‚“ã©ã‚“é•·ããªã‚‹ã ã‘ãªã‚‰è‰¯ã„ã‘ã©ã‚¯ãƒ©ã‚¹å†…ã‚¯ãƒ©ã‚¹ã¨ã‹æ§‹é€ ä½“ã®åå‰ãŒ + ä»˜ãã®ä¸æ­£ãªçŠ¶æ…‹ã§å‡ºã¦ãã‚‹ã€‚ãã®ä»–ã«ã‚‚ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã¸ã®å¯¾å¿œã¨ã‹ãªã‚“ã¨ã‹ã€çµå±€ä½•ã‹ãŒå¿…è¦ã«ãªã‚‹ã€‚ãã‚Œãªã‚‰ã°ã¨å¯èƒ½ãªé™ã‚ŠçŸ­ãæ›¸ã‘ã‚‹ã‚ˆã†ã«ã—ãŸã€‚

ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆç³»ã¯ãƒˆãƒªãƒƒã‚­ãƒ¼ã ã‘ã©é–‹ç™ºæ©Ÿã§ã®å®Ÿè¡Œãªã®ã§ã¾ã‚è‰¯ã—ã€‚

<!------- End of Details JA Tag -------></details></p>


```csharp
// indent utility
sb.IndentChar(' ');  // default
sb.IndentSize(4);    // default
sb.IndentLevel(3);   // template default
sb.IndentBegin("void MethodName() {");
{
    // cast int value to enum
    sb.IndentLine($"MyObject.EnumValue = ({usg<MyEnum>()})intValue");
    // --- or ---
    string CAST_MY_ENUM = "(" + usg(targetTypeVar) + ")";
    sb.IndentLine($"MyObject.EnumValue = {CAST_MY_ENUM}intValue");
}
sb.IndentEnd("}");
```

```csharp
using static SatorImaging.UnitySourceGenerator.USGFullNameOf;  // usg<T>() to work

// usg<T>() allows to write refactoring-ready code with auto completion
sb.Append($"public static {usg<Dictionary<int, float>>()} MyDict = new() {{ init... }};");

// usg<T>{params string[]) to generate full name with specified member name.
usg<MyClass>("NestedStruct.MyField");  // -> global::Full.Namespace.To.MyClass.MyStruct.MyField
// most strict refactoring-ready code
usg<MyClass>(nameof(MyClass.NestedStruct), nameof(MyClass.NestedStruct.MyField));

// usg(object valueOrType, bool isFullName) to retrieve full type definition literal
static class MyClass {
    Dictionary<int, List<Dictionary<string, float[][]>[]>> Complex = new(0);  // usg() throws when null
}
usg(MyClass.Complex);  // -> global::...Dictionary<int, global::...List<global::...Dictionary<string, float[][]>[]>>
```



Utility Functions for Build Event
=================================

There are utility functions to perform source code generation on build event.

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

`IPostprocessBuildWithReport` ã‚‚å®Ÿè£…ã—ã‚ˆã†ã‹ã¨æ€ã£ãŸã‚‚ã®ã®ã€ãƒ“ãƒ«ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã«å‹æ‰‹ã«å‡¦ç†è¿½åŠ ã™ã‚‹ã®ã¯ãªã‚“ã‹è¨³ã‚ã‹ã‚‰ã‚“ãŒå‹•ã‹ã‚“ã®åŸå› ã ã—ã€BuildReport ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’èµ°æŸ»ã™ã‚‹å‡¦ç†ã¯åŠ¹ç‡ã‚‚è‰¯ããªã„ã€‚ã¨ã„ã†ã“ã¨ã§ã€‚

<!------- End of Details JA Tag -------></details></p>


```csharp
// perform code generation by class name if you don't know where it is.
USGUtility.ForceGenerateByName(nameof(MinimalGenerator));

// perform code generation by known path.
USGEngine.ProcessFile(assetPath, true, true);  // force re-generate all related files
```



Technical Notes
===============

As of C# 9.0, it doesn't allow to define `abstract static` methods in interface, USG reports error when source generator class doesn't implement required static methods.

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

ç†æƒ³ã¯ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã™ãŒã€Unity 2021 ã¯ C# 9.0 ã§ `abstract static` ã‚’å«ã‚“ã ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãŒä½¿ãˆã¾ã›ã‚“ã€‚

ã—ã‚‡ã†ãŒãªã„ã®ã§ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’ç¢ºèªã—ã¦å­˜åœ¨ã—ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã—ã¾ã™ã€‚

<!------- End of Details JA Tag -------></details></p>


![](https://dl.dropbox.com/s/kstbafbnyc54k2l/USG_IntefaceError.jpg)



## Naming Convention

- Generator class name and filename must be matched.
- Class name must be unique in whole project.
- Classes are ignored if defined in assembly which name starts with:
    - `Unity` (no trailing dot)
    - `System.`
    - `Mono.`


<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

- ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹ã®åå‰ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã¨ä¸€è‡´
- ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã®åå‰ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§ä¸€æ„
- ã‚¯ãƒ©ã‚¹ãŒä»¥ä¸‹ã§å§‹ã¾ã‚‹åå‰ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã§å®£è¨€ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¯¾è±¡ã¨ã—ãªã„
    - `Unity` (æœ«å°¾ãƒ‰ãƒƒãƒˆç„¡ã—)
    - `System.`
    - `Mono.`

<!------- End of Details JA Tag -------></details></p>



## `<auto-generated/>` Tag

USG automatically adds document tag at the beginning of generated file. You can remove this document tag by `sb.Clear()` in `Emit()` method.


<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

æ¸¡ã•ã‚Œã‚‹ `StringBuilder` ã®å†’é ­ã«ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚°ãŒå…¥ã£ã¦ã¾ã™ã€‚ä¸è¦ãªã‚‰ `sb.Clear()` ã—ã¦ãã ã•ã„ã€‚

<!------- End of Details JA Tag -------></details></p>



Unity Editor Integration
========================

## Installation

Use the following git URL in Unity Package Manager (UPM).

- Latest: https://github.com/sator-imaging/Unity-AltSourceGenerator.git
- v2.0.1: https://github.com/sator-imaging/Unity-AltSourceGenerator.git#v2.0.1


## USG Control Panel & Window

- `Main Menu > Edit > Project Settings > Alternative Source Generator`

    ![](https://dl.dropbox.com/scl/fi/jijclnarrruxdt590vss1/USG_Panel.png?rlkey=k44lc9swk0mmui849ck7tappk&dl=0)


    - **On**
        - Include generator in auto run sequence.

    - **Run**
        - Run generator on demand. Note that `OverwriteIfFileExists` setting on attribute is ignored.

    - **Link**
        - Click name to unveil generator script file in project window.
        - Down arrow icon (â–¼) will show referencing emitters below.
        - Linked chain icon (ğŸ”—) to unveil emitted file in `USG.g` folder.
    - ğŸ—‘ï¸
        - Delete *emitted* file from `USG.g` folder.

- `Main Menu > Tools > Alternative Source Generator`
    - open as a window.

    ![](https://dl.dropbox.com/scl/fi/dedb30699adhss8zqwft5/USG_Window.png?rlkey=13gq24ypciw00o9tkhicdpxpe&dl=0)



## Context Menu

<p><details lang="ja" --open><summary><small>æ—¥æœ¬èª / JA</small></summary>

æ‰‹å‹•ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«ã‚‚å¯èƒ½ã§ã™ã€‚ã€Œã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ã‹ã€Œç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’é¸æŠã—ã¦ã€Project ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§ `Reimport` ã‹ `Unity Source Generator` ä»¥ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Reimport ã—ãŸå ´åˆã¯ã€é–¢é€£ã™ã‚‹ã‚¯ãƒ©ã‚¹ã™ã¹ã¦ãŒå†ç”Ÿæˆã•ã‚Œã¾ã™ã€‚`Force Generate...` ã¯ã‚¯ãƒ©ã‚¹ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã®è¨­å®šã«é–¢ã‚ã‚‰ãšå¼·åˆ¶çš„ã«ä¸Šæ›¸ãç”Ÿæˆã—ã¾ã™ã€‚

<!------- End of Details JA Tag -------></details></p>

There is an ability to invoke source code generation by hand. With generator script file or generated file selected in Project window:


- `Reimport`
    - This command respects `OverwriteIfFileExists` setting by generator class attribute.
    - Classes referencing selected generator will also be re-generated.

- `Unity Source Generator > Force Generate`
    - This command will force re-generate source code even if overwrite setting is disabled.


![](https://dl.dropbox.com/s/skqa6mwh932lsrg/USG_FireEvent.jpg)



Troubleshooting
===============

#### Generator script update is not applied to generated file.

Usually, this problem happens when Unity automatically reloads updated scripts WITHOUT Editor window getting focus. To solve the problem:

1. Close Unity and Visual Studio.
1. Restart Unity.
1. Launch Visual Studio by double clicking `.cs` script in Unity Editor.

> *NOTE*: There is experimental feature to suspend auto reloading while Unity Editor in background (doesn't get focused). Open `Edit > Project Settings > Alternative Source Generator` to enable it.





Copyright
=========

Copyright &copy; 2023 Sator Imaging, all rights reserved.



License
=======

<p>
<details>
<summary>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</summary>

```text
MIT License

Copyright (c) 2023 Sator Imaging

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

</details>
</p>





&nbsp;  
&nbsp;

# Devnote


## TODO

<!-- useless
- Add new attribute option `UseCustomWriter` to use it's own file writer instead of builtin writer. For the "non-allocation" addicted developers.
    - `USGEngine.ProcessingFile()` doesn't care what happens in custom writer. just returns true in this situation.
    - Option is for generator class. Referenced generator class doesn't have `UnitySourceGenerator` attribute so that need to retrieve it from target classes. (how handle conflicts?)
    - `USGContext.UseCustomWriter` can be used to prevent writing file but `StringBuilder` is built prior to `Emit()` method.
-->


Clarify terminology of generator types, especially in source code comments.
currently, referenced/referencing generator, or just generator, confusing!

- Generator class:
    - Class has `Emit()` method to generate code. And does NOT have `UnitySourceGenerator` attribute.
    - current -> "referenced" generator, "referenced only" generator, etc.

- Emitter class: (or Target, Source, Client, Igniter, Invoker, Caller?)
    - Class has `UnitySourceGenerator` attribute to invoke code generation. And does NOT have `Emit()` method.
    - current -> "referencing" class, just generator, etc.

- Self-Emit class:
    - Class has both `Emit()` method and `UnitySourceGenerator` attribute. Works only a file. No dependencies.
